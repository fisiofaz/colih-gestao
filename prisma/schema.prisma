generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS: Ajudam a padronizar as escolhas 
enum UserRole {
  ADMIN
  COLIH
  GVP
}

enum ContactType {
  NEW_CONTACT       
  UPDATE_INFO      
}

enum DoctorType {
  COOPERATING       // Médico cooperador 
  CONSULTANT        // Médico consultor 
  OTHER             
}

enum Gender {
  MALE
  FEMALE
}

// MODELO DO USUÁRIO DO SISTEMA (Membro da Colih)
model User {
  id                String    @id @default(cuid())
  name              String?
  email             String?   @unique
  password          String?
  role              UserRole  @default(GVP)
  whatsapp          String?

  mustChangePassword Boolean @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  auditLogs         AuditLog[]  
  createdDoctors    Doctor[]
  activityReports   ActivityReport[]
}

// MODELO DO MÉDICO
model Doctor {
  id String         @id      @default(cuid())

  // Parte 1: Metadados do contato
  type              DoctorType
  contactDate       DateTime?  
  
  // Parte 2: Dados Pessoais
  firstName         String      
  lastName          String   
  crm               String?   
  phoneHome         String?
  phoneMobile       String?     
  email             String? 
  gender            Gender   
  address           String   
  city              String     
  state             String  
  zipCode           String?
  country           String?

  
  // Parte 3: Dados Médicos
  specialty1        String    //  - Obrigatório ter pelo menos uma
  specialty2        String?   
  specialty3        String?   
  subSpecialties1   String?  //  Podemos guardar como texto ou criar outra tabela depois
  subSpecialties2   String? 
  subSpecialties3   String?
  
  // Tipos de pacientes [cite: 39-42]
  acceptsAdult      Boolean @default(false)
  acceptsChild      Boolean @default(false)
  acceptsNewborn    Boolean @default(false)

  // Controle do Sistema
  notes             String?   
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Quem cadastrou?
  createdBy         User     @relation(fields: [createdById], references: [id])
  createdById       String
  documents         Document[]
  visits            Visit[]
  isSus             Boolean  @default(false)
  hasHealthPlan     Boolean  @default(false)
  responsibleMember String?
}

// NOVO MODEL: Histórico de Ações
model AuditLog {
  id        String   @id @default(cuid())
  action    String   // Ex: "CREATE", "UPDATE", "DELETE"
  resource  String   // Ex: "Doctor", "User"
  details   String?  // Ex: "Nome: João Silva" ou JSON com detalhes
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Document {
  id        String   @id @default(cuid())
  url       String   // O link do arquivo na internet
  filename  String   // O nome original (ex: cartao.jpg)
  doctorId  String
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Visit {
  id        String   @id @default(cuid())
  date      DateTime // Data e Hora da visita
  notes     String?  // Ex: "Conversar sobre sangue"
  status    String   @default("PENDING") // "PENDING" ou "DONE"
  
  doctorId  String
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

model ActivityReport {
  id          String   @id @default(cuid())
  month       String   // Formato "YYYY-MM" (ex: "2023-12")
  
  soloCases   Int      @default(0) // Casos atendidos sozinho
  sharedCases Int      @default(0) // Casos em dupla
  visits      Int      @default(0) // Visitas preventivas
  
  partners    String?  // Nome do(s) irmão(s) com quem trabalhou
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([userId, month]) // Garante que o membro só mande 1 relatório por mês
}